<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcard TOEIC - Lặp lại ngắt quãng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body { height: 100%; overflow-x: hidden; }
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        body.modal-open {
            overflow: hidden;
        }
        .flashcard-container { perspective: 1200px; }
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.7s cubic-bezier(0.4, 0.0, 0.2, 1); cursor: pointer; }
        .flashcard.is-flipped { transform: rotateY(-180deg); }
        .flashcard-face { 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            backface-visibility: hidden; 
            -webkit-backface-visibility: hidden; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            border-radius: 1.75rem; /* Smoother radius */
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); /* Stronger shadow */
            padding: 2rem; /* More padding */
            border: 1px solid rgba(0,0,0,0.05); 
        }
        .flashcard-front { background-color: white; color: #111827; }
        .flashcard-back { background-color: #f8fafc; color: #0f172a; transform: rotateY(-180deg); overflow-y: auto; justify-content: flex-start; }
        .animated-button { transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1); box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        .animated-button:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .animated-button:active { transform: translateY(0px); box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        .card-action-btn { position: absolute; top: 16px; right: 16px; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(4px); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; z-index: 10; }
        .card-action-btn:hover { transform: scale(1.1); }
        #review-btn.is-marked .unmarked-icon { display: none; }
        #review-btn:not(.is-marked) .marked-icon { display: none; }
        .play-audio-btn { background: none; border: none; padding: 6px; cursor: pointer; transition: all 0.2s; display: inline-flex; vertical-align: middle; color: #0f172a; }
        .play-audio-btn:hover { transform: scale(1.1); color: #0ea5e9; }
        .play-audio-btn.playing, .play-audio-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .play-audio-btn.playing svg { color: #0ea5e9; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-left: 8px; }
        
        .modal.hidden { display: none; }
        .progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(16px, 1fr));
            gap: 4px;
        }
        .progress-dot { cursor: pointer; transition: transform 0.1s ease-in-out; }
        .progress-dot:hover { transform: scale(1.5); }
        
        #toast-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2d3748;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
        }
        #toast-notification.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -10px);
        }
    </style>
</head>
<body class="flex flex-col items-center p-4 sm:p-6">

    <div class="w-full max-w-3xl mx-auto flex flex-col flex-grow h-full">
        <main class="flex-grow flex flex-col">
            <div class="flashcard-container flex-grow w-full mb-6 relative">
                <div id="flashcard" class="flashcard">
                    <div class="flashcard-face flashcard-front">
                        <div id="card-front-content" class="text-center p-4">
                            <p class="text-xl text-slate-500">Đang tải dữ liệu từ vựng...</p>
                        </div>
                    </div>
                    <div class="flashcard-face flashcard-back">
                        <div id="card-back-content" class="text-left w-full h-full"></div>
                    </div>
                </div>
                <button id="review-btn" class="card-action-btn animated-button" title="Đánh dấu 'Chưa nhớ'">
                    <svg class="unmarked-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                    <svg class="marked-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="#ef4444" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                </button>
                <button id="delete-btn" class="card-action-btn animated-button" title="Xóa khỏi danh sách 'Chưa ghi nhớ'">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                </button>
            </div>

            <div id="navigation-controls" class="flex items-center justify-between w-full my-4">
                <button id="prev-btn" class="animated-button px-6 py-3 bg-white rounded-xl flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/></svg>
                    Trước
                </button>
                <div id="card-counter" class="text-lg font-semibold text-slate-700">0 / 0</div>
                <button id="next-btn" class="animated-button px-6 py-3 bg-white rounded-xl flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none">
                    Sau
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z"/></svg>
                </button>
            </div>
            
            <div id="srs-controls" class="hidden items-center justify-center w-full mb-4 space-x-2">
                 <div id="srs-rating-group" class="hidden items-center justify-center w-full space-x-2">
                    <button data-rating="hard" class="srs-rating-btn animated-button px-4 py-3 sm:px-6 bg-red-500 text-white rounded-xl flex-1">Khó</button>
                    <button data-rating="good" class="srs-rating-btn animated-button px-4 py-3 sm:px-6 bg-blue-500 text-white rounded-xl flex-1">Bình thường</button>
                    <button data-rating="easy" class="srs-rating-btn animated-button px-4 py-3 sm:px-6 bg-green-500 text-white rounded-xl flex-1">Dễ</button>
                 </div>
                 <button id="shuffle-btn" class="hidden animated-button p-3 bg-white text-slate-600 rounded-xl" title="Xáo trộn danh sách ôn tập">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>
                 </button>
            </div>
        </main>
        
        <footer class="w-full pt-6 pb-2">
             <div class="p-3 mb-6 bg-white rounded-2xl shadow-inner-sm flex flex-wrap items-center justify-center gap-x-4 gap-y-2 w-full max-w-xl mx-auto border border-slate-200">
                <button id="play-pause-btn" class="animated-button px-4 py-2 bg-sky-500 text-white font-semibold rounded-lg flex items-center justify-center gap-2 disabled:bg-slate-300 disabled:transform-none disabled:shadow-none"></button>
                <div class="flex items-center gap-1">
                    <label for="play-speed-input" class="font-medium text-slate-600 text-xs whitespace-nowrap">Tốc độ:</label>
                    <input type="number" id="play-speed-input" min="1" max="60" value="4" class="bg-white text-slate-900 text-xs rounded-lg w-14 p-1.5 text-center border border-slate-300 focus:ring-2 focus:ring-sky-300 focus:outline-none">
                    <span class="text-xs text-slate-500">s</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="flex items-center gap-1">
                        <input type="checkbox" id="auto-flip-toggle" class="h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-500 focus:ring-offset-2">
                        <label for="auto-flip-toggle" class="font-medium text-slate-600 text-xs">Tự lật</label>
                    </div>
                    <div class="flex items-center gap-1">
                        <input type="checkbox" id="auto-play-audio-toggle" class="h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-500 focus:ring-offset-2">
                        <label for="auto-play-audio-toggle" class="font-medium text-slate-600 text-xs">Tự đọc từ</label>
                    </div>
                    <div class="flex items-center gap-1">
                        <input type="checkbox" id="auto-play-examples-toggle" class="h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-500 focus:ring-offset-2">
                        <label for="auto-play-examples-toggle" class="font-medium text-slate-600 text-xs">Tự phát ví dụ</label>
                    </div>
                </div>
                <button id="progress-matrix-btn" class="animated-button p-2 bg-white text-slate-600 rounded-lg" title="Tiến độ học tập">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18.7 8a6 6 0 0 0-6 0"/><path d="M12.7 14a6 6 0 0 0-6 0"/><path d="M6.7 20a6 6 0 0 0-6 0"/></svg>
                </button>
            </div>
            <label for="category-select" class="block text-center text-xl font-semibold text-slate-600 mb-4">Chọn Chủ Đề</label>
            <div class="relative w-full max-w-sm mx-auto">
                <select id="category-select" class="w-full p-3 text-base font-medium text-slate-700 bg-white border border-slate-300 rounded-lg shadow-sm appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer">
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-700">
                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                </div>
            </div>
        </footer>
    </div>
    
    <div id="error-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 id="error-title" class="text-lg font-bold text-red-600 mb-2">Đã xảy ra lỗi</h3>
            <p id="error-message" class="text-slate-600 mb-4">Không thể thực hiện yêu cầu. Vui lòng thử lại.</p>
            <button id="close-error-modal-btn" class="w-full bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">Đóng</button>
        </div>
    </div>

    <div id="progress-matrix-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl p-6 max-w-4xl w-full max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-slate-800">Tiến độ học tập</h3>
                <button id="close-progress-matrix-btn" class="text-slate-500 hover:text-slate-800">&times;</button>
            </div>
            <div id="progress-stats" class="grid grid-cols-2 md:grid-cols-4 items-center justify-center gap-4 text-xs mb-4">
                <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded-sm bg-slate-300"></div><span>Chưa học (<span id="stats-unstudied-count">0</span> - <span id="stats-unstudied-percent">0%</span>)</span></div>
                <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded-sm bg-red-500"></div><span>Khó (<span id="stats-hard-count">0</span> - <span id="stats-hard-percent">0%</span>)</span></div>
                <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded-sm bg-blue-500"></div><span>Bình thường (<span id="stats-good-count">0</span> - <span id="stats-good-percent">0%</span>)</span></div>
                <div class="flex items-center gap-1.5"><div class="w-3 h-3 rounded-sm bg-green-500"></div><span>Dễ (<span id="stats-easy-count">0</span> - <span id="stats-easy-percent">0%</span>)</span></div>
            </div>
            <div id="progress-grid-container" class="progress-grid overflow-y-auto p-2 bg-slate-100 rounded-lg">
            </div>
            <div class="mt-4 pt-4 border-t border-slate-200">
                <button id="reset-progress-btn" class="w-full bg-red-100 text-red-700 px-4 py-2 rounded-lg hover:bg-red-200 transition-colors">Xóa toàn bộ tiến trình học tập</button>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 id="confirm-title" class="text-lg font-bold text-slate-800 mb-2">Xác nhận</h3>
            <p id="confirm-message" class="text-slate-600 mb-4">Bạn có chắc chắn muốn thực hiện hành động này không?</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-btn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300">Hủy</button>
                <button id="confirm-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Xác nhận</button>
            </div>
        </div>
    </div>

    <div id="toast-notification"></div>

    <script>
        const SRS_PROGRESS_KEY = "toeicSrsProgressData";
        const REVIEW_LIST_KEY = "toeicReviewListData";
        const REVIEW_SESSION_KEY = "toeicReviewSession";

        let vocabularyData = {};
        let srsProgressData = {};

        const SRS_INTERVALS = { 1: 1, 2: 3, 3: 7, 4: 14, 5: 30, 6: 90 };
        const MAX_SRS_LEVEL = Object.keys(SRS_INTERVALS).length;

        let currentCategoryKey = '';
        let currentWords = [];
        let currentIndex = 0;
        let isPlaying = false;
        let autoplayInterval = null;
        let isReviewMode = false;
        let lastCompletedSessionWords = [];
        
        let speechSynth = window.speechSynthesis;
        let availableVoices = [];
        let voicesLoaded = false;
        
        let audioContext;
        let activeAudioElement = null;

        const ui = {
            flashcard: document.getElementById('flashcard'),
            cardFrontContent: document.getElementById('card-front-content'),
            cardBackContent: document.getElementById('card-back-content'),
            navigationControls: document.getElementById('navigation-controls'),
            srsControls: document.getElementById('srs-controls'),
            srsRatingGroup: document.getElementById('srs-rating-group'),
            prevBtn: document.getElementById('prev-btn'),
            nextBtn: document.getElementById('next-btn'),
            cardCounter: document.getElementById('card-counter'),
            categorySelect: document.getElementById('category-select'),
            reviewBtn: document.getElementById('review-btn'),
            deleteBtn: document.getElementById('delete-btn'),
            playPauseBtn: document.getElementById('play-pause-btn'),
            playSpeedInput: document.getElementById('play-speed-input'),
            autoFlipToggle: document.getElementById('auto-flip-toggle'),
            autoPlayAudioToggle: document.getElementById('auto-play-audio-toggle'),
            autoPlayExamplesToggle: document.getElementById('auto-play-examples-toggle'),
            errorModal: document.getElementById('error-modal'),
            errorTitle: document.getElementById('error-title'),
            errorMessage: document.getElementById('error-message'),
            closeErrorModalBtn: document.getElementById('close-error-modal-btn'),
            progressMatrixModal: document.getElementById('progress-matrix-modal'),
            progressMatrixBtn: document.getElementById('progress-matrix-btn'),
            closeProgressMatrixBtn: document.getElementById('close-progress-matrix-btn'),
            progressGridContainer: document.getElementById('progress-grid-container'),
            shuffleBtn: document.getElementById('shuffle-btn'),
            toast: document.getElementById('toast-notification'),
            resetProgressBtn: document.getElementById('reset-progress-btn'),
            confirmModal: document.getElementById('confirm-modal'),
            confirmTitle: document.getElementById('confirm-title'),
            confirmMessage: document.getElementById('confirm-message'),
            confirmBtn: document.getElementById('confirm-btn'),
            cancelBtn: document.getElementById('cancel-btn'),
            statsUnstudiedCount: document.getElementById('stats-unstudied-count'),
            statsUnstudiedPercent: document.getElementById('stats-unstudied-percent'),
            statsHardCount: document.getElementById('stats-hard-count'),
            statsHardPercent: document.getElementById('stats-hard-percent'),
            statsGoodCount: document.getElementById('stats-good-count'),
            statsGoodPercent: document.getElementById('stats-good-percent'),
            statsEasyCount: document.getElementById('stats-easy-count'),
            statsEasyPercent: document.getElementById('stats-easy-percent'),
        };
        
        const playIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/></svg><span>Phát</span>`;
        const pauseIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5zm5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5z"/></svg><span>Dừng</span>`;
        const speakerIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>`;
        const loadingIconSVG = `<div class="loader"></div>`;

        const API_KEY = "AIzaSyArL11WIWq1Me2ScsMNTMknlMnsHzbsq6Q";
        const TTS_MODEL = "gemini-2.5-flash-preview-tts";
        const VOICE_NAME = "Puck";

        function unlockAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }
        
        function getSrsProgress(wordKey) {
            return srsProgressData[wordKey] || { level: 1, nextReviewDate: new Date().toISOString() };
        }

        function updateSrsProgress(wordKey, rating) {
            let progress = srsProgressData.hasOwnProperty(wordKey) ? srsProgressData[wordKey] : { level: 1 };
            let currentLevel = progress.level;

            if (rating === 'hard') {
                currentLevel = 1;
            } else if (rating === 'good') {
                // No change
            } else if (rating === 'easy') {
                currentLevel = Math.min(MAX_SRS_LEVEL, currentLevel + 1);
            }

            const intervalDays = SRS_INTERVALS[currentLevel];
            const nextReviewDate = new Date();
            nextReviewDate.setDate(nextReviewDate.getDate() + intervalDays);
            
            srsProgressData[wordKey] = {
                level: currentLevel,
                nextReviewDate: nextReviewDate.toISOString()
            };
            saveSrsProgress();
        }

        function getReviewQueue() {
            const today = new Date();
            today.setHours(23, 59, 59, 999);
            let queue = [];
            for (const category in vocabularyData) {
                if (category === "Chưa ghi nhớ") continue;
                for (const wordKey in vocabularyData[category]) {
                    if (srsProgressData.hasOwnProperty(wordKey)) {
                        const progress = srsProgressData[wordKey];
                        if (new Date(progress.nextReviewDate) <= today) {
                            queue.push(wordKey);
                        }
                    } else {
                        queue.push(wordKey);
                    }
                }
            }
            return queue;
        }
        
        function updateProgressMatrixAndStats() {
            ui.progressGridContainer.innerHTML = '';
            
            let allWords = [];
            for (const category in vocabularyData) {
                if (category === "Chưa ghi nhớ") continue;
                for (const wordKey in vocabularyData[category]) {
                    allWords.push({ key: wordKey, category: category });
                }
            }

            const counts = { unstudied: 0, hard: 0, good: 0, easy: 0 };
            const totalWords = allWords.length;

            allWords.forEach(wordInfo => {
                 const dot = document.createElement('div');
                 let dotColorClass = 'bg-slate-300';
                 let dotTitle = `${wordInfo.key} (Chủ đề: ${wordInfo.category})`;

                 if (srsProgressData.hasOwnProperty(wordInfo.key)) {
                     const progress = srsProgressData[wordInfo.key];
                     const level = progress.level;
                     dotTitle += ` - Level: ${level}`;

                     if (level <= 2) {
                         dotColorClass = 'bg-red-500';
                         counts.hard++;
                     } else if (level <= 4) {
                         dotColorClass = 'bg-blue-500';
                         counts.good++;
                     } else {
                         dotColorClass = 'bg-green-500';
                         counts.easy++;
                     }
                 } else {
                    counts.unstudied++;
                 }
                 
                 dot.className = `progress-dot w-4 h-4 rounded-sm ${dotColorClass}`;
                 dot.title = dotTitle;
                 dot.dataset.wordKey = wordInfo.key;
                 dot.dataset.category = wordInfo.category;

                 dot.addEventListener('click', () => {
                    const wordCategory = dot.dataset.category;
                    const wordKey = dot.dataset.wordKey;
                    
                    const wordIndex = Object.keys(vocabularyData[wordCategory]).indexOf(wordKey);

                    if (wordIndex !== -1) {
                        selectCategory(wordCategory);
                        currentIndex = wordIndex;
                        displayCard();
                        ui.progressMatrixModal.classList.add('hidden');
                    }
                 });

                 ui.progressGridContainer.appendChild(dot);
            });

            const calcPercent = (count) => totalWords > 0 ? ((count / totalWords) * 100).toFixed(0) : 0;
            ui.statsUnstudiedCount.textContent = counts.unstudied;
            ui.statsUnstudiedPercent.textContent = `${calcPercent(counts.unstudied)}%`;
            ui.statsHardCount.textContent = counts.hard;
            ui.statsHardPercent.textContent = `${calcPercent(counts.hard)}%`;
            ui.statsGoodCount.textContent = counts.good;
            ui.statsGoodPercent.textContent = `${calcPercent(counts.good)}%`;
            ui.statsEasyCount.textContent = counts.easy;
            ui.statsEasyPercent.textContent = `${calcPercent(counts.easy)}%`;
        }

        function saveDataToLocalStorage() {
            try {
                const reviewList = vocabularyData["Chưa ghi nhớ"] || {};
                localStorage.setItem(REVIEW_LIST_KEY, JSON.stringify(reviewList));
            } catch (e) { console.error("Failed to save review list:", e); }
        }

        function loadDataFromLocalStorage() {
            const savedData = localStorage.getItem(REVIEW_LIST_KEY);
            if (savedData) {
                try {
                    const loadedReviewList = JSON.parse(savedData);
                    if (!vocabularyData["Chưa ghi nhớ"]) vocabularyData["Chưa ghi nhớ"] = {};
                    Object.assign(vocabularyData["Chưa ghi nhớ"], loadedReviewList);
                } catch (e) { console.error("Failed to parse review list:", e); }
            }
        }

        function saveSrsProgress() {
            try {
                localStorage.setItem(SRS_PROGRESS_KEY, JSON.stringify(srsProgressData));
            } catch (e) { console.error("Failed to save SRS progress:", e); }
        }

        function loadSrsProgress() {
            const savedData = localStorage.getItem(SRS_PROGRESS_KEY);
            if (savedData) {
                try {
                    srsProgressData = JSON.parse(savedData);
                } catch (e) {
                    console.error("Failed to parse SRS progress:", e);
                    srsProgressData = {};
                }
            }
        }

        function saveReviewSession() {
            if (!isReviewMode) return;
            const sessionData = {
                words: currentWords,
                index: currentIndex
            };
            localStorage.setItem(REVIEW_SESSION_KEY, JSON.stringify(sessionData));
        }

        function loadReviewSession() {
            const savedSession = localStorage.getItem(REVIEW_SESSION_KEY);
            if (savedSession) {
                try {
                    return JSON.parse(savedSession);
                } catch (e) {
                    return null;
                }
            }
            return null;
        }

        function clearReviewSession() {
             localStorage.removeItem(REVIEW_SESSION_KEY);
        }
        
        function createCategoryDropdown() {
            ui.categorySelect.innerHTML = '';
            let categoryKeys = Object.keys(vocabularyData);

            const reviewQueue = getReviewQueue();
            const reviewCategoryKey = "Chưa ghi nhớ";
            const reviewList = vocabularyData[reviewCategoryKey];
            const hasReviewItems = reviewList && Object.keys(reviewList).length > 0;
            
            let sortedKeys = categoryKeys.filter(key => key !== reviewCategoryKey);
            sortedKeys.sort();

            const reviewOption = document.createElement('option');
            reviewOption.value = "SRS_REVIEW_MODE";
            reviewOption.textContent = `★ Ôn tập hôm nay (${reviewQueue.length})`;
            ui.categorySelect.appendChild(reviewOption);

            if (hasReviewItems) {
                const unmarkedOption = document.createElement('option');
                unmarkedOption.value = reviewCategoryKey;
                unmarkedOption.textContent = `♥ ${reviewCategoryKey} (${Object.keys(reviewList).length})`;
                ui.categorySelect.appendChild(unmarkedOption);
            }

            const separator = document.createElement('option');
            separator.disabled = true;
            separator.textContent = '──────────';
            ui.categorySelect.appendChild(separator);

            sortedKeys.forEach((key) => {
                const count = Object.keys(vocabularyData[key]).length;
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${key} (${count})`;
                ui.categorySelect.appendChild(option);
            });
        }

        function selectCategory(key, customWordList = null, resumeIndex = 0) {
            stopAutoplay();
            currentCategoryKey = key;
            isReviewMode = (key === "SRS_REVIEW_MODE");

            if (isReviewMode) {
                currentWords = customWordList || [];
            } else {
                currentWords = vocabularyData[key] ? Object.keys(vocabularyData[key]) : [];
                clearReviewSession();
            }
            
            currentIndex = resumeIndex;
            ui.categorySelect.value = key; 
            updateNavigation(); 
            displayCard();
        }

        function displayCard() {
            if (ui.flashcard.classList.contains('is-flipped')) {
                ui.flashcard.classList.remove('is-flipped');
            }
            
            ui.navigationControls.style.display = isReviewMode ? 'none' : 'flex';
            ui.srsControls.classList.toggle('hidden', !isReviewMode);
            ui.srsControls.classList.toggle('flex', isReviewMode);
            ui.srsRatingGroup.classList.add('hidden');
            ui.srsRatingGroup.classList.remove('flex');
            ui.shuffleBtn.classList.toggle('hidden', !isReviewMode || currentWords.length < 2);
            ui.shuffleBtn.classList.toggle('flex', isReviewMode && currentWords.length >= 2);

            if (isReviewMode) {
                ui.autoFlipToggle.checked = false;
                ui.autoFlipToggle.disabled = true;
            } else {
                ui.autoFlipToggle.disabled = false;
            }

            const isManualReviewCategory = currentCategoryKey === "Chưa ghi nhớ";
            ui.reviewBtn.style.display = isManualReviewCategory || isReviewMode ? 'none' : 'flex';
            ui.deleteBtn.style.display = isManualReviewCategory ? 'flex' : 'none';

            setTimeout(() => { 
                ui.cardFrontContent.innerHTML = '';
                ui.cardBackContent.innerHTML = '';

                if (currentWords.length === 0 || currentIndex >= currentWords.length) {
                    if (isReviewMode) {
                        lastCompletedSessionWords = [...currentWords];
                        const messageP = document.createElement('p');
                        messageP.className = 'text-xl text-slate-500 mb-4';
                        messageP.textContent = 'Chúc mừng! Bạn đã hoàn thành phiên ôn tập.';
                        
                        const reviewAgainBtn = document.createElement('button');
                        reviewAgainBtn.className = 'animated-button px-6 py-3 bg-sky-600 text-white rounded-xl';
                        reviewAgainBtn.textContent = 'Ôn tập thêm lần nữa';
                        reviewAgainBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            restartReviewSession();
                        });
                        
                        ui.cardFrontContent.append(messageP, reviewAgainBtn);
                        clearReviewSession();
                    } else {
                        ui.cardFrontContent.innerHTML = `<p class="text-xl text-slate-500">Chủ đề này chưa có từ nào.</p>`;
                    }
                    
                    ui.reviewBtn.style.display = 'none';
                    ui.deleteBtn.style.display = 'none';
                    if(isReviewMode) {
                        ui.srsControls.classList.add('hidden');
                        ui.srsRatingGroup.classList.add('hidden');
                        ui.shuffleBtn.classList.add('hidden');
                    }
                    updateNavigation();
                    return;
                }
                const wordKey = currentWords[currentIndex];
                const cardData = findWordData(wordKey);
                
                if (!cardData) { 
                    ui.cardFrontContent.innerHTML = `<p class="text-xl text-red-500">Lỗi: Không tìm thấy dữ liệu từ.</p>`; 
                    updateNavigation();
                    return; 
                }

                ui.cardFrontContent.innerHTML = `<h2 class="text-3xl sm:text-4xl md:text-5xl font-bold text-center break-words text-slate-800">${wordKey}</h2>`;
                
                const backContentWrapper = document.createElement('div');
                backContentWrapper.className = 'p-4 w-full';

                const headerDiv = document.createElement('div');
                headerDiv.className = 'flex flex-col items-start gap-2 mb-4';
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'flex items-baseline gap-2';
                
                const wordTitle = document.createElement('h3');
                wordTitle.className = 'text-3xl font-bold text-sky-800';
                wordTitle.textContent = wordKey;
                
                const phoneticText = document.createElement('p');
                phoneticText.className = 'text-lg text-slate-500';
                phoneticText.textContent = cardData.phonetic || '';

                titleDiv.append(wordTitle, phoneticText);

                const mainAudioBtn = document.createElement('button');
                mainAudioBtn.className = 'play-audio-btn text-xl';
                mainAudioBtn.dataset.textToSpeak = wordKey;
                mainAudioBtn.title = 'Phát âm';
                mainAudioBtn.innerHTML = speakerIconSVG;
                mainAudioBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    playAudio(e.currentTarget.dataset.textToSpeak, e.currentTarget);
                });

                headerDiv.append(titleDiv, mainAudioBtn);
                backContentWrapper.appendChild(headerDiv);

                cardData.meanings.forEach((meaningData) => {
                    const meaningBlock = document.createElement('div');
                    meaningBlock.className = 'mb-5 p-4 bg-white rounded-xl border';

                    const meaningHeader = document.createElement('div');
                    meaningHeader.className = 'flex items-center gap-3 mb-3';
                    
                    const typeBadge = document.createElement('span');
                    typeBadge.className = 'text-xs font-semibold uppercase text-sky-600 bg-sky-100 px-2 py-1 rounded-full';
                    typeBadge.textContent = meaningData.type;

                    const meaningText = document.createElement('p');
                    meaningText.className = 'text-lg font-semibold text-slate-800';
                    meaningText.textContent = meaningData.meaning;

                    meaningHeader.append(typeBadge, meaningText);
                    
                    const exampleList = document.createElement('ul');
                    exampleList.className = 'space-y-3 list-inside';

                    meaningData.examples.forEach((ex) => {
                        const listItem = document.createElement('li');
                        listItem.className = 'text-base';
                        
                        const englishLine = document.createElement('p');
                        englishLine.className = 'text-slate-700';
                        englishLine.textContent = `“${ex.en}” `;

                        const exampleAudioBtn = document.createElement('button');
                        exampleAudioBtn.className = 'play-audio-btn';
                        exampleAudioBtn.dataset.textToSpeak = ex.en;
                        exampleAudioBtn.title = 'Phát âm ví dụ';
                        exampleAudioBtn.innerHTML = speakerIconSVG;
                        exampleAudioBtn.addEventListener('click', (e) => {
                           e.stopPropagation();
                           playAudio(e.currentTarget.dataset.textToSpeak, e.currentTarget);
                        });

                        englishLine.appendChild(exampleAudioBtn);

                        const vietnameseLine = document.createElement('p');
                        vietnameseLine.className = 'text-sm text-slate-500 italic ml-4';
                        vietnameseLine.textContent = `→ ${ex.vi}`;

                        listItem.append(englishLine, vietnameseLine);
                        exampleList.appendChild(listItem);
                    });

                    meaningBlock.append(meaningHeader, exampleList);
                    backContentWrapper.appendChild(meaningBlock);
                });

                ui.cardBackContent.appendChild(backContentWrapper);

                updateReviewButtonState();
                updateNavigation();
                if(isReviewMode) saveReviewSession();
            }, 150);
        }

        function handleSrsAnswer(rating) {
            if (!isReviewMode || currentWords.length === 0) return;
            
            const wordKey = currentWords[currentIndex];
            updateSrsProgress(wordKey, rating);
            updateProgressMatrixAndStats();

            currentIndex++;
            if (currentIndex >= currentWords.length) {
                displayCard();
            } else {
                displayCard();
            }
            updateNavigation();
        }
        
        speechSynth.onvoiceschanged = () => {
            if (!voicesLoaded) {
                availableVoices = speechSynth.getVoices();
                voicesLoaded = true;
            }
        };
        async function geminiFetch(model, payload, retries = 3, delay = 1000) {
            if (!API_KEY) { console.warn("Gemini API Key is missing. Falling back to browser TTS."); return null; }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${API_KEY}`;
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) {
                        if (response.status === 400) { showErrorModal("Lỗi API Key hoặc yêu cầu không hợp lệ."); return null; }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error(`API call attempt ${i + 1} failed:`, error);
                    if (i === retries - 1) { showErrorModal(`Không thể kết nối tới Gemini API sau ${retries} lần thử.`); return null; }
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
        }
        function base64ToArrayBuffer(base64) { const binaryString = window.atob(base64); const len = binaryString.length; const bytes = new Uint8Array(len); for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i); return bytes.buffer; }
        function pcmToWav(pcmData, sampleRate) { const numChannels = 1, bytesPerSample = 2, blockAlign = numChannels * bytesPerSample, byteRate = sampleRate * blockAlign, dataSize = pcmData.byteLength, buffer = new ArrayBuffer(44 + dataSize), view = new DataView(buffer); function writeString(view, offset, string) { for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); } writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + dataSize, true); writeString(view, 8, 'WAVE'); writeString(view, 12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, numChannels, true); view.setUint32(24, sampleRate, true); view.setUint32(28, byteRate, true); view.setUint16(32, blockAlign, true); view.setUint16(34, 16, true); writeString(view, 36, 'data'); view.setUint32(40, dataSize, true); const pcm16 = new Int16Array(pcmData); for (let i = 0; i < pcm16.length; i++) view.setInt16(44 + i * 2, pcm16[i], true); return new Blob([view], { type: 'audio/wav' }); }
        
        function playBrowserAudio(text, buttonEl) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            const originalContent = buttonEl.innerHTML;
            buttonEl.innerHTML = loadingIconSVG;
            buttonEl.disabled = true;

            const cleanup = () => {
                buttonEl.innerHTML = originalContent;
                buttonEl.disabled = false;
            };

            utterance.onend = cleanup;
            utterance.onerror = (e) => {
                console.error("SpeechSynthesis Error:", e);
                cleanup();
            };

            const setVoiceAndSpeak = () => {
                const englishVoice = availableVoices.find(voice => voice.name === 'Google US English') || availableVoices.find(voice => voice.lang.startsWith('en-'));
                if (englishVoice) {
                    utterance.voice = englishVoice;
                }
                speechSynth.speak(utterance);
            };

            if (voicesLoaded) {
                setVoiceAndSpeak();
            } else {
                speechSynth.onvoiceschanged = () => {
                    if (!voicesLoaded) {
                        availableVoices = speechSynth.getVoices();
                        voicesLoaded = true;
                        if (buttonEl.disabled) {
                            setVoiceAndSpeak();
                        }
                    }
                };
            }
        }

        async function playAudio(text, buttonEl) {
            if (!text || buttonEl.disabled) return;
            unlockAudioContext(); 

            if (activeAudioElement) {
                activeAudioElement.pause();
            }
            if (speechSynth.speaking) {
                speechSynth.cancel();
            }

            if (!API_KEY) {
                playBrowserAudio(text, buttonEl);
                return;
            }

            const originalContent = buttonEl.innerHTML;
            buttonEl.innerHTML = loadingIconSVG;
            buttonEl.disabled = true;

            try {
                const payload = { contents: [{ parts: [{ text }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: VOICE_NAME } } } }, model: TTS_MODEL };
                const result = await geminiFetch(TTS_MODEL, payload);
                if (!result) {
                    playBrowserAudio(text, buttonEl);
                    return;
                }
                const audioData = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                const mimeType = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType;
                if (!audioData || !mimeType || !mimeType.startsWith("audio/")) throw new Error("Invalid audio data received.");
                
                const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                const pcmData = base64ToArrayBuffer(audioData);
                const wavBlob = pcmToWav(new Int16Array(pcmData), sampleRate);
                const audioUrl = URL.createObjectURL(wavBlob);
                
                const audio = new Audio(audioUrl);
                activeAudioElement = audio;

                const cleanup = () => {
                    buttonEl.innerHTML = originalContent;
                    buttonEl.disabled = false;
                    URL.revokeObjectURL(audioUrl);
                    if(activeAudioElement === audio) {
                        activeAudioElement = null;
                    }
                };

                audio.onended = cleanup;
                audio.onpause = cleanup;
                audio.onerror = () => {
                    cleanup();
                    showErrorModal("Lỗi khi phát file âm thanh.");
                };
                
                audio.play();

            } catch (error) {
                console.error("Error playing Gemini audio:", error);
                buttonEl.innerHTML = originalContent;
                buttonEl.disabled = false;
                playBrowserAudio(text, buttonEl);
            }
        }
        
        async function playAudioSequence(buttons) {
            for (const btn of buttons) {
                const text = btn.dataset.textToSpeak;
                if (text) {
                    await new Promise(resolve => {
                        playAudio(text, btn);
                        const checkEnd = setInterval(() => {
                            if (!btn.disabled || !isPlaying) {
                                clearInterval(checkEnd);
                                resolve();
                            }
                        }, 100);
                    });
                    if (!isPlaying) break;
                }
            }
        }
        function findWordData(wordKey) { for (const category in vocabularyData) { if (category !== "Chưa ghi nhớ" && vocabularyData[category][wordKey]) { return vocabularyData[category][wordKey]; } } return null; }
        function updateReviewButtonState() { if (!currentWords || currentWords.length === 0 || currentCategoryKey === "Chưa ghi nhớ") { ui.reviewBtn.classList.remove("is-marked"); return; } const wordKey = currentWords[currentIndex]; const isMarked = !!(vocabularyData["Chưa ghi nhớ"] && vocabularyData["Chưa ghi nhớ"][wordKey]); ui.reviewBtn.classList.toggle("is-marked", isMarked); }
        function handleReviewClick() { if (!currentWords || currentWords.length === 0) return; const wordKey = currentWords[currentIndex]; const isMarked = !!(vocabularyData["Chưa ghi nhớ"] && vocabularyData["Chưa ghi nhớ"][wordKey]); if (isMarked) { delete vocabularyData["Chưa ghi nhớ"][wordKey]; } else { const wordData = findWordData(wordKey); if (wordData) { if (!vocabularyData["Chưa ghi nhớ"]) { vocabularyData["Chưa ghi nhớ"] = {}; } vocabularyData["Chưa ghi nhớ"][wordKey] = { ...wordData }; } } saveDataToLocalStorage(); createCategoryDropdown(); updateReviewButtonState(); }
        function handleDeleteFromReview() { if (currentCategoryKey !== "Chưa ghi nhớ" || currentWords.length === 0) return; const wordKey = currentWords[currentIndex]; delete vocabularyData["Chưa ghi nhớ"][wordKey]; saveDataToLocalStorage(); currentWords.splice(currentIndex, 1); if (currentIndex >= currentWords.length) { currentIndex = Math.max(0, currentWords.length - 1); } createCategoryDropdown(); displayCard(); }
        function updateNavigation() { const hasWords = currentWords.length > 0; const hasMultipleWords = currentWords.length > 1; ui.cardCounter.textContent = hasWords ? `${currentIndex + 1}/${currentWords.length}` : "0 / 0"; const isDisabled = isPlaying || !hasWords; ui.prevBtn.disabled = isDisabled || !hasMultipleWords || currentIndex === 0; ui.nextBtn.disabled = isDisabled || !hasMultipleWords || currentIndex === currentWords.length - 1; ui.playPauseBtn.disabled = !hasWords; ui.playSpeedInput.disabled = isPlaying || ui.autoPlayAudioToggle.checked || ui.autoPlayExamplesToggle.checked; ui.autoFlipToggle.disabled = isPlaying || isReviewMode; ui.autoPlayAudioToggle.disabled = isDisabled; ui.autoPlayExamplesToggle.disabled = isDisabled; }
        function navigate(direction) { if (currentWords.length > 0) { const newIndex = currentIndex + direction; if (newIndex >= 0 && newIndex < currentWords.length) { currentIndex = newIndex; displayCard(); } } }
        function stopAutoplay() { if (isPlaying) { isPlaying = false; clearTimeout(autoplayInterval); autoplayInterval = null; if (speechSynth.speaking) { speechSynth.cancel(); } if (activeAudioElement) { activeAudioElement.pause(); } ui.playPauseBtn.innerHTML = playIconSVG; ui.flashcard.style.pointerEvents = "auto"; updateNavigation(); } }
        function startAutoplay() { if (currentWords.length > 0) { isPlaying = true; ui.playPauseBtn.innerHTML = pauseIconSVG; ui.flashcard.style.pointerEvents = "none"; updateNavigation(); runAutoplayCycle(); } else { showErrorModal("Vui lòng chọn một chủ đề có từ vựng để bắt đầu."); } }
        async function runAutoplayCycle() { 
            if (!isPlaying) return; 
            if (ui.flashcard.classList.contains("is-flipped")) { ui.flashcard.classList.remove("is-flipped"); await new Promise(r => setTimeout(r, 350)); } 
            displayCard(); 
            await new Promise(r => setTimeout(r, 200)); 
            if (!isPlaying) return; 
            const shouldFlip = ui.autoFlipToggle.checked; 
            const shouldPlayAudio = ui.autoPlayAudioToggle.checked; 
            const shouldPlayExamples = ui.autoPlayExamplesToggle.checked; 
            const isAudioMode = shouldPlayAudio || shouldPlayExamples; 
            if (isAudioMode) { 
                if (shouldFlip) { ui.flashcard.classList.add("is-flipped"); await new Promise(r => setTimeout(r, 200)); } 
                if (!isPlaying) return; 
                const wordKey = currentWords[currentIndex]; 
                let audioButtonsToPlay = []; 
                if (shouldPlayAudio) { const mainBtn = ui.cardBackContent.querySelector(`.play-audio-btn[data-text-to-speak="${wordKey}"]`); if (mainBtn) audioButtonsToPlay.push(mainBtn); } 
                if (shouldPlayExamples) { const exampleBtns = ui.cardBackContent.querySelectorAll(`.play-audio-btn:not([data-text-to-speak="${wordKey}"])`); if (exampleBtns.length > 0) audioButtonsToPlay.push(exampleBtns[0]); } 
                await playAudioSequence(audioButtonsToPlay); 
            } else { 
                let delay = parseInt(ui.playSpeedInput.value, 10) * 1000; 
                await new Promise(r => setTimeout(r, shouldFlip ? delay / 2 : delay)); 
                if (!isPlaying) return; 
                if (shouldFlip) { ui.flashcard.classList.add("is-flipped"); await new Promise(r => setTimeout(r, 200)); } 
                if (isPlaying) await new Promise(r => setTimeout(r, delay / 2)); 
            } 
            if (!isPlaying) return; 
            if (currentIndex < currentWords.length - 1) { navigate(1); runAutoplayCycle(); } else { stopAutoplay(); } 
        }
        
        function showToast(message) {
            ui.toast.textContent = message;
            ui.toast.classList.add('show');
            setTimeout(() => {
                ui.toast.classList.remove('show');
            }, 2000);
        }

        function showErrorModal(message, title = "Đã xảy ra lỗi") { 
            ui.errorTitle.textContent = title;
            ui.errorMessage.textContent = message; 
            ui.errorModal.classList.remove("hidden"); 
            lockBodyScroll();
        }

        function showConfirmModal(title, message, onConfirm) {
            ui.confirmTitle.textContent = title;
            ui.confirmMessage.textContent = message;
            ui.confirmModal.classList.remove('hidden');
            lockBodyScroll();

            const confirmHandler = () => {
                onConfirm();
                ui.confirmModal.classList.add('hidden');
                unlockBodyScroll();
                cleanup();
            };

            const cancelHandler = () => {
                ui.confirmModal.classList.add('hidden');
                unlockBodyScroll();
                cleanup();
            };
            
            const cleanup = () => {
                ui.confirmBtn.removeEventListener('click', confirmHandler);
                ui.cancelBtn.removeEventListener('click', cancelHandler);
            };

            ui.confirmBtn.addEventListener('click', confirmHandler);
            ui.cancelBtn.addEventListener('click', cancelHandler);
        }

        function shuffleCurrentQueue() {
            if (!isReviewMode || currentWords.length < 2) return;
            for (let i = currentWords.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [currentWords[i], currentWords[j]] = [currentWords[j], currentWords[i]];
            }
            currentIndex = 0;
            displayCard();
            showToast("Đã xáo trộn danh sách ôn tập!");
        }

        function restartReviewSession() {
            if (!isReviewMode || lastCompletedSessionWords.length === 0) return;
            
            currentWords = [...lastCompletedSessionWords];
            currentIndex = 0;

            for (let i = currentWords.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [currentWords[i], currentWords[j]] = [currentWords[j], currentWords[i]];
            }
            
            displayCard();
        }

        function resetAllProgress() {
            showConfirmModal(
                "Xác nhận xóa tiến trình",
                "Bạn có chắc chắn muốn xóa toàn bộ tiến trình học tập không? Hành động này không thể hoàn tác.",
                () => {
                    srsProgressData = {};
                    localStorage.removeItem(SRS_PROGRESS_KEY);
                    clearReviewSession();
                    updateProgressMatrixAndStats();
                    showToast("Đã xóa toàn bộ tiến trình học tập.");
                    const firstCategory = Object.keys(vocabularyData).find(k => k !== "Chưa ghi nhớ");
                    if (firstCategory) {
                        selectCategory(firstCategory);
                    }
                }
            );
        }

        function lockBodyScroll() {
            document.body.classList.add('modal-open');
        }

        function unlockBodyScroll() {
            document.body.classList.remove('modal-open');
        }

        function initializeApp(data) {
            vocabularyData = data;
            if (!vocabularyData["Chưa ghi nhớ"]) {
                vocabularyData["Chưa ghi nhớ"] = {};
            }
            loadDataFromLocalStorage(); 
            loadSrsProgress();
            ui.playPauseBtn.innerHTML = playIconSVG;
            createCategoryDropdown();
            
            ui.prevBtn.addEventListener('click', () => navigate(-1));
            ui.nextBtn.addEventListener('click', () => navigate(1));
            
            let touchstartX = 0, touchstartY = 0;
            ui.flashcard.addEventListener('touchstart', e => {
                touchstartX = e.changedTouches[0].screenX;
                touchstartY = e.changedTouches[0].screenY;
            }, { passive: true });
            ui.flashcard.addEventListener('touchend', e => { 
                const touchendX = e.changedTouches[0].screenX;
                const touchendY = e.changedTouches[0].screenY;
                const swipeThreshold = 50;
                const swipeRestraint = 100;
                const swipedX = touchendX - touchstartX;
                const swipedY = touchendY - touchstartY;
                if (Math.abs(swipedX) < swipeThreshold || Math.abs(swipedY) > swipeRestraint) return;
                if (swipedX < 0 && !ui.nextBtn.disabled) navigate(1);
                if (swipedX > 0 && !ui.prevBtn.disabled) navigate(-1);
            });

            ui.flashcard.addEventListener('click', (e) => {
                if (e.target.closest('.card-action-btn') || e.target.closest('.play-audio-btn')) {
                    return;
                }

                if (isReviewMode) {
                    ui.flashcard.classList.toggle('is-flipped');
                    const isFlipped = ui.flashcard.classList.contains('is-flipped');
                    ui.srsRatingGroup.classList.toggle('hidden', !isFlipped);
                    ui.srsRatingGroup.classList.toggle('flex', isFlipped);
                } else if (currentWords.length > 0) {
                    ui.flashcard.classList.toggle('is-flipped');
                }
            });

            ui.playPauseBtn.addEventListener('click', () => { isPlaying ? stopAutoplay() : startAutoplay(); });
            ui.reviewBtn.addEventListener('click', handleReviewClick);
            ui.deleteBtn.addEventListener('click', handleDeleteFromReview);
            ui.closeErrorModalBtn.addEventListener('click', () => {
                ui.errorModal.classList.add('hidden');
                unlockBodyScroll();
            });
            
            ui.progressMatrixBtn.addEventListener('click', () => {
                updateProgressMatrixAndStats();
                ui.progressMatrixModal.classList.remove('hidden');
                lockBodyScroll();
            });
            ui.closeProgressMatrixBtn.addEventListener('click', () => {
                ui.progressMatrixModal.classList.add('hidden');
                unlockBodyScroll();
            });
            ui.progressMatrixModal.addEventListener('click', (e) => {
                if (e.target === ui.progressMatrixModal) {
                    ui.progressMatrixModal.classList.add('hidden');
                    unlockBodyScroll();
                }
            });

            ui.shuffleBtn.addEventListener('click', shuffleCurrentQueue);
            ui.resetProgressBtn.addEventListener('click', resetAllProgress);

            document.querySelectorAll('.srs-rating-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleSrsAnswer(e.target.dataset.rating);
                });
            });

            const audioCheckboxes = [ui.autoPlayAudioToggle, ui.autoPlayExamplesToggle];
            audioCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    ui.playSpeedInput.disabled = ui.autoPlayAudioToggle.checked || ui.autoPlayExamplesToggle.checked;
                });
            });

            ui.categorySelect.addEventListener('change', (e) => {
                const selectedKey = e.target.value;
                if (selectedKey === "SRS_REVIEW_MODE") {
                    let reviewQueue = getReviewQueue();
                    for (let i = reviewQueue.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [reviewQueue[i], reviewQueue[j]] = [reviewQueue[j], reviewQueue[i]];
                    }
                    selectCategory(selectedKey, reviewQueue, 0);
                } else {
                    selectCategory(selectedKey);
                }
            });

            const savedSession = loadReviewSession();
            if (savedSession && savedSession.words.length > 0 && savedSession.index < savedSession.words.length) {
                selectCategory("SRS_REVIEW_MODE", savedSession.words, savedSession.index);
            } else {
                let reviewQueue = getReviewQueue();
                if (reviewQueue.length > 0) {
                    for (let i = reviewQueue.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [reviewQueue[i], reviewQueue[j]] = [reviewQueue[j], reviewQueue[i]];
                    }
                     selectCategory("SRS_REVIEW_MODE", reviewQueue, 0);
                } else {
                    const firstCategory = Object.keys(vocabularyData).find(k => k !== "Chưa ghi nhớ");
                    if (firstCategory) {
                        selectCategory(firstCategory);
                    } else {
                        ui.cardFrontContent.innerHTML = `<p class="text-xl text-slate-500">Không có dữ liệu từ vựng nào.</p>`;
                        updateNavigation();
                    }
                }
            }
        }
        
        async function startApp() {
            try {
                const response = await fetch('vocabulary.json');
                if (!response.ok) {
                    throw new Error(`Không tìm thấy tệp vocabulary.json hoặc có lỗi mạng (status: ${response.status})`);
                }
                const data = await response.json();
                initializeApp(data);
            } catch (error) {
                console.error('Could not load vocabulary data:', error);
                showErrorModal(`${error.message}. Hãy chắc chắn rằng bạn đã có tệp vocabulary.json trong cùng thư mục.`, "Lỗi tải dữ liệu");
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            startApp();
            document.body.addEventListener('click', unlockAudioContext, { once: true });
            document.body.addEventListener('touchend', unlockAudioContext, { once: true });
        });
    </script>
</body>
</html>
