<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcard TOEIC - Lặp lại ngắt quãng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body { height: 100%; overflow-x: hidden; }
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; padding-top: 1rem; padding-bottom: 1rem; }
        .flashcard-container { perspective: 1200px; }
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.7s cubic-bezier(0.4, 0.0, 0.2, 1); cursor: pointer; }
        .flashcard.is-flipped { transform: rotateY(-180deg); }
        .flashcard-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 1.5rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.1); padding: 1.5rem; border: 1px solid rgba(0,0,0,0.05); }
        .flashcard-front { background-color: white; color: #111827; }
        .flashcard-back { background-color: #f8fafc; color: #0f172a; transform: rotateY(-180deg); overflow-y: auto; justify-content: flex-start; }
        .animated-button { transition: all 0.2s cubic-bezier(0.4, 0.0, 0.2, 1); box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        .animated-button:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .animated-button:active { transform: translateY(0px); box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        .category-button.active { transform: translateY(-2px) scale(1.05); }
        .category-button.active:not(.unmarked-button):not(.review-button) { background-color: #0284c7 !important; color: white !important; font-weight: 600; box-shadow: 0 10px 15px -3px rgb(30 159 210 / 0.3); }
        .unmarked-button.active { background-color: #f97316 !important; color: white !important; font-weight: 600; box-shadow: 0 10px 15px -3px rgb(249 115 22 / 0.3); }
        .review-button { border: 1px solid #16a34a; }
        .review-button.active { background-color: #16a34a !important; color: white !important; font-weight: 600; box-shadow: 0 10px 15px -3px rgb(22 163 74 / 0.3); }
        .card-action-btn { position: absolute; top: 16px; right: 16px; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(4px); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; z-index: 10; }
        .card-action-btn:hover { transform: scale(1.1); }
        #review-btn.is-marked .unmarked-icon { display: none; }
        #review-btn:not(.is-marked) .marked-icon { display: none; }
        .play-audio-btn { background: none; border: none; padding: 6px; cursor: pointer; transition: all 0.2s; display: inline-flex; vertical-align: middle; color: #0f172a; }
        .play-audio-btn:hover { transform: scale(1.1); color: #0ea5e9; }
        .play-audio-btn.playing, .play-audio-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .play-audio-btn.playing svg { color: #0ea5e9; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-left: 8px; }
    </style>
</head>
<body class="flex flex-col items-center">

    <div class="w-full max-w-3xl mx-auto flex flex-col flex-grow">
        <main class="flex-grow">
            <div class="flashcard-container w-full h-[32rem] md:h-[36rem] mb-6 relative mt-8">
                <div id="flashcard" class="flashcard">
                    <div class="flashcard-face flashcard-front">
                        <div id="card-front-content" class="text-center p-4">
                            <p class="text-xl text-slate-500">Đang tải dữ liệu từ vựng...</p>
                        </div>
                    </div>
                    <div class="flashcard-face flashcard-back">
                        <div id="card-back-content" class="text-left w-full h-full"></div>
                    </div>
                </div>
                <button id="review-btn" class="card-action-btn animated-button" title="Đánh dấu 'Chưa nhớ'">
                    <svg class="unmarked-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                    <svg class="marked-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#ef4444" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                </button>
                <button id="delete-btn" class="card-action-btn animated-button" title="Xóa khỏi danh sách 'Chưa ghi nhớ'">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                </button>
            </div>

            <!-- Navigation / SRS Controls -->
            <div id="navigation-controls" class="flex items-center justify-between w-full mb-8">
                <button id="prev-btn" class="animated-button px-6 py-3 bg-white rounded-xl flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/></svg>
                    Trước
                </button>
                <div id="card-counter" class="text-lg font-semibold text-slate-700">0 / 0</div>
                <button id="next-btn" class="animated-button px-6 py-3 bg-white rounded-xl flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none">
                    Sau
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z"/></svg>
                </button>
            </div>
            
            <div id="srs-controls" class="hidden items-center justify-center w-full mb-8 space-x-4">
                 <button data-rating="hard" class="srs-btn animated-button px-6 py-3 bg-red-500 text-white rounded-xl flex-1">Khó</button>
                 <button data-rating="good" class="srs-btn animated-button px-6 py-3 bg-blue-500 text-white rounded-xl flex-1">Bình thường</button>
                 <button data-rating="easy" class="srs-btn animated-button px-6 py-3 bg-green-500 text-white rounded-xl flex-1">Dễ</button>
            </div>

            <div class="p-3 bg-white rounded-2xl shadow-inner-sm flex flex-wrap items-center justify-center gap-3 w-full max-w-xl mx-auto border border-slate-200">
                <button id="play-pause-btn" class="animated-button px-4 py-2 bg-sky-500 text-white font-semibold rounded-lg flex items-center justify-center gap-2 disabled:bg-slate-300 disabled:transform-none disabled:shadow-none"></button>
                <div class="flex items-center gap-1">
                    <label for="play-speed-input" class="font-medium text-slate-600 text-xs whitespace-nowrap">Tốc độ:</label>
                    <input type="number" id="play-speed-input" min="1" max="60" value="4" class="bg-white text-slate-900 text-xs rounded-lg w-14 p-1.5 text-center border border-slate-300 focus:ring-2 focus:ring-sky-300 focus:outline-none">
                    <span class="text-xs text-slate-500">s</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="flex items-center gap-1">
                        <input type="checkbox" id="auto-flip-toggle" class="h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-500 focus:ring-offset-2">
                        <label for="auto-flip-toggle" class="font-medium text-slate-600 text-xs">Tự lật</label>
                    </div>
                    <div class="flex items-center gap-1">
                        <input type="checkbox" id="auto-play-audio-toggle" class="h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-500 focus:ring-offset-2">
                        <label for="auto-play-audio-toggle" class="font-medium text-slate-600 text-xs">Tự đọc từ</label>
                    </div>
                    <div class="flex items-center gap-1">
                        <input type="checkbox" id="auto-play-examples-toggle" class="h-4 w-4 rounded border-slate-300 text-sky-600 focus:ring-sky-500 focus:ring-offset-2">
                        <label for="auto-play-examples-toggle" class="font-medium text-slate-600 text-xs">Tự phát ví dụ</label>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="w-full pt-8 pb-4">
            <h2 class="text-center text-xl font-semibold text-slate-600 mb-4">Chọn Chủ Đề</h2>
            <div id="category-container" class="flex flex-wrap justify-center gap-3"></div>
        </footer>
    </div>
    
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 class="text-lg font-bold text-red-600 mb-2">Đã xảy ra lỗi</h3>
            <p id="error-message" class="text-slate-600 mb-4">Không thể thực hiện yêu cầu. Vui lòng thử lại.</p>
            <button id="close-error-modal" class="w-full bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">Đóng</button>
        </div>
    </div>

    <script>
        // --- APP LOGIC ---
        const SRS_PROGRESS_KEY = "toeicSrsProgressData";
        const REVIEW_LIST_KEY = "toeicReviewListData"; // Renamed for clarity
        let vocabularyData = {};
        let srsProgressData = {}; // Stores SRS level and next review date for each word

        // SRS Intervals in days for each level
        const SRS_INTERVALS = {
            1: 1,  // 1 day
            2: 3,  // 3 days
            3: 7,  // 1 week
            4: 14, // 2 weeks
            5: 30, // 1 month
            6: 90, // 3 months
        };
        const MAX_SRS_LEVEL = Object.keys(SRS_INTERVALS).length;
        
        const categoryColors = [
            { bg: '#e0f2fe', text: '#0c4a6e' }, { bg: '#dcfce7', text: '#166534' },
            { bg: '#ffedd5', text: '#9a3412' }, { bg: '#fce7f3', text: '#9d2463' },
            { bg: '#eef2ff', text: '#312e81' }, { bg: '#f3e8ff', text: '#6b21a8' },
            { bg: '#ccfbf1', text: '#115e59' }, { bg: '#fef9c3', text: '#854d0e' },
            { bg: '#dbeafe', text: '#1e40af' }, { bg: '#fee2e2', text: '#991b1b' },
            { bg: '#ecfccb', text: '#3f6212' }, { bg: '#fae8ff', text: '#581c87' },
            { bg: '#cffafe', text: '#155e75' }, { bg: '#ede9fe', text: '#5b21b6' },
            { bg: '#ffe4e6', text: '#9f1239' }, { bg: '#f1f5f9', text: '#1e293b' }
        ];

        let currentCategoryKey = '';
        let currentWords = [];
        let currentIndex = 0;
        let isPlaying = false;
        let autoplayInterval = null;
        let flipTimeout = null;
        let isReviewMode = false;
        
        let speechSynth = window.speechSynthesis;
        let isSpeaking = false;
        let voicesLoaded = false;
        let availableVoices = [];
        let currentApiAudio = null;

        const ui = {
            flashcard: document.getElementById('flashcard'),
            cardFrontContent: document.getElementById('card-front-content'),
            cardBackContent: document.getElementById('card-back-content'),
            navigationControls: document.getElementById('navigation-controls'),
            srsControls: document.getElementById('srs-controls'),
            prevBtn: document.getElementById('prev-btn'),
            nextBtn: document.getElementById('next-btn'),
            cardCounter: document.getElementById('card-counter'),
            categoryContainer: document.getElementById('category-container'),
            reviewBtn: document.getElementById('review-btn'),
            deleteBtn: document.getElementById('delete-btn'),
            playPauseBtn: document.getElementById('play-pause-btn'),
            playSpeedInput: document.getElementById('play-speed-input'),
            autoFlipToggle: document.getElementById('auto-flip-toggle'),
            autoPlayAudioToggle: document.getElementById('auto-play-audio-toggle'),
            autoPlayExamplesToggle: document.getElementById('auto-play-examples-toggle'),
            errorModal: document.getElementById('error-modal'),
            errorMessage: document.getElementById('error-message'),
            closeErrorModalBtn: document.getElementById('close-error-modal'),
        };
        
        const playIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/></svg><span>Phát</span>`;
        const pauseIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5zm5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5z"/></svg><span>Dừng</span>`;
        const speakerIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>`;
        const loadingIconSVG = `<div class="loader"></div>`;

        const API_KEY = ""; // IMPORTANT: Paste your API Key here if you want to use Gemini TTS
        const TTS_MODEL = "gemini-2.5-flash-preview-tts";
        const VOICE_NAME = "Puck";

        // --- SRS Logic ---
        function getSrsProgress(wordKey) {
            return srsProgressData[wordKey] || { level: 1, nextReviewDate: new Date().toISOString() };
        }

        function updateSrsProgress(wordKey, rating) {
            let progress = getSrsProgress(wordKey);
            let currentLevel = progress.level;

            if (rating === 'hard') {
                currentLevel = Math.max(1, currentLevel - 1);
            } else if (rating === 'good') {
                currentLevel = Math.min(MAX_SRS_LEVEL, currentLevel + 1);
            } else if (rating === 'easy') {
                currentLevel = Math.min(MAX_SRS_LEVEL, currentLevel + 2);
            }

            const intervalDays = SRS_INTERVALS[currentLevel];
            const nextReviewDate = new Date();
            nextReviewDate.setDate(nextReviewDate.getDate() + intervalDays);
            
            srsProgressData[wordKey] = {
                level: currentLevel,
                nextReviewDate: nextReviewDate.toISOString()
            };
            saveSrsProgress();
        }

        function getReviewQueue() {
            const today = new Date();
            today.setHours(23, 59, 59, 999); // Set to end of today
            const queue = [];
            for (const category in vocabularyData) {
                if (category === "Chưa ghi nhớ") continue;
                for (const wordKey in vocabularyData[category]) {
                    const progress = getSrsProgress(wordKey);
                    if (new Date(progress.nextReviewDate) <= today) {
                        queue.push(wordKey);
                    }
                }
            }
            return queue;
        }

        // --- Data Handling ---
        function saveDataToLocalStorage() {
            try {
                const reviewList = vocabularyData["Chưa ghi nhớ"] || {};
                localStorage.setItem(REVIEW_LIST_KEY, JSON.stringify(reviewList));
            } catch (e) { console.error("Failed to save review list:", e); }
        }

        function loadDataFromLocalStorage() {
            const savedData = localStorage.getItem(REVIEW_LIST_KEY);
            if (savedData) {
                try {
                    const loadedReviewList = JSON.parse(savedData);
                    if (!vocabularyData["Chưa ghi nhớ"]) vocabularyData["Chưa ghi nhớ"] = {};
                    Object.assign(vocabularyData["Chưa ghi nhớ"], loadedReviewList);
                } catch (e) { console.error("Failed to parse review list:", e); }
            }
        }

        function saveSrsProgress() {
            try {
                localStorage.setItem(SRS_PROGRESS_KEY, JSON.stringify(srsProgressData));
            } catch (e) { console.error("Failed to save SRS progress:", e); }
        }

        function loadSrsProgress() {
            const savedData = localStorage.getItem(SRS_PROGRESS_KEY);
            if (savedData) {
                try {
                    srsProgressData = JSON.parse(savedData);
                } catch (e) {
                    console.error("Failed to parse SRS progress:", e);
                    srsProgressData = {};
                }
            }
        }
        
        // --- UI and App Flow ---
        function createCategoryButtons() {
            ui.categoryContainer.innerHTML = '';
            let categoryKeys = Object.keys(vocabularyData);

            const reviewQueue = getReviewQueue();
            const reviewCategory = { key: "SRS_REVIEW_MODE", name: `Ôn tập hôm nay (${reviewQueue.length})`, count: reviewQueue.length };
            
            const reviewCategoryKey = "Chưa ghi nhớ";
            const reviewList = vocabularyData[reviewCategoryKey];
            const hasReviewItems = reviewList && Object.keys(reviewList).length > 0;
            
            let sortedKeys = categoryKeys.filter(key => key !== reviewCategoryKey);
            sortedKeys.sort();

            if (hasReviewItems) {
                sortedKeys.unshift(reviewCategoryKey);
            }
            
            // Add the SRS Review button
            const reviewBtn = document.createElement('button');
            reviewBtn.textContent = reviewCategory.name;
            reviewBtn.dataset.key = reviewCategory.key;
            reviewBtn.className = 'category-button animated-button review-button px-4 py-2 text-sm font-medium bg-white rounded-lg text-green-700';
            reviewBtn.onclick = () => selectCategory(reviewCategory.key, reviewQueue);
            ui.categoryContainer.appendChild(reviewBtn);


            sortedKeys.forEach((key) => {
                const count = Object.keys(vocabularyData[key]).length;
                const button = document.createElement('button');
                button.textContent = `${key} (${count})`;
                button.dataset.key = key;
                button.className = 'category-button animated-button px-4 py-2 text-sm font-medium bg-white rounded-lg';
                
                if (key === reviewCategoryKey) {
                    button.classList.add('unmarked-button', 'text-amber-600');
                } else {
                    const colorIndex = (sortedKeys.indexOf(key) - (hasReviewItems ? 1 : 0)) % categoryColors.length;
                    const color = categoryColors[colorIndex];
                    button.style.backgroundColor = color.bg;
                    button.style.color = color.text;
                }

                button.onclick = () => selectCategory(key);
                ui.categoryContainer.appendChild(button);
            });
        }

        function selectCategory(key, customWordList = null) {
            stopAutoplay();
            currentCategoryKey = key;
            isReviewMode = (key === "SRS_REVIEW_MODE");

            if (isReviewMode) {
                currentWords = customWordList || [];
            } else {
                currentWords = Object.keys(vocabularyData[key]);
            }
            
            currentIndex = 0;
            document.querySelectorAll('.category-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.key === key);
            });

            // Show/hide appropriate controls
            ui.navigationControls.style.display = isReviewMode ? 'none' : 'flex';
            ui.srsControls.classList.add('hidden'); // Hide SRS buttons until card is flipped

            displayCard();
        }

        function displayCard() {
            if (ui.flashcard.classList.contains('is-flipped')) {
                ui.flashcard.classList.remove('is-flipped');
            }
            
            // Hide SRS controls when showing a new card front
            if (!isReviewMode) {
                ui.navigationControls.style.display = 'flex';
            }
            ui.srsControls.classList.add('hidden');

            const isManualReviewCategory = currentCategoryKey === "Chưa ghi nhớ";
            ui.reviewBtn.style.display = isManualReviewCategory || isReviewMode ? 'none' : 'flex';
            ui.deleteBtn.style.display = isManualReviewCategory ? 'flex' : 'none';

            setTimeout(() => { 
                if (currentWords.length === 0) {
                    const message = isReviewMode ? "Chúc mừng! Bạn đã hoàn thành tất cả các từ cần ôn tập hôm nay." : "Chủ đề này chưa có từ nào.";
                    ui.cardFrontContent.innerHTML = `<p class="text-xl text-slate-500">${message}</p>`;
                    ui.cardBackContent.innerHTML = '';
                    ui.reviewBtn.style.display = 'none';
                    ui.deleteBtn.style.display = 'none';
                    updateNavigation();
                    return;
                }
                const wordKey = currentWords[currentIndex];
                const cardData = findWordData(wordKey);
                
                if (!cardData) { 
                    ui.cardFrontContent.innerHTML = `<p class="text-xl text-red-500">Lỗi: Không tìm thấy dữ liệu từ.</p>`; 
                    return; 
                }

                ui.cardFrontContent.innerHTML = `<h2 class="text-4xl md:text-5xl font-bold text-center break-words text-slate-800">${wordKey}</h2>`;
                
                let backHTML = `<div class="p-4 w-full">
                    <div class="flex flex-col items-start gap-2 mb-4">
                        <div class="flex items-baseline gap-2">
                            <h3 class="text-3xl font-bold text-sky-800">${wordKey}</h3>
                            <p class="text-lg text-slate-500">${cardData.phonetic || ''}</p>
                        </div>
                        <button class="play-audio-btn text-xl" data-text-to-speak="${wordKey}" title="Phát âm">${speakerIconSVG}</button>
                    </div>`;

                cardData.meanings.forEach((meaningData) => {
                    backHTML += `<div class="mb-5 p-4 bg-white rounded-xl border">
                        <div class="flex items-center gap-3 mb-3">
                            <span class="text-xs font-semibold uppercase text-sky-600 bg-sky-100 px-2 py-1 rounded-full">${meaningData.type}</span>
                            <p class="text-lg font-semibold text-slate-800">${meaningData.meaning}</p>
                        </div>
                        <ul class="space-y-3 list-inside">`;
                    meaningData.examples.forEach((ex) => {
                        const audioButton = `<button class="play-audio-btn" data-text-to-speak="${ex.en.replace(/"/g, '&quot;')}" title="Phát âm ví dụ">${speakerIconSVG}</button>`;
                        backHTML += `<li class="text-base">
                            <p class="text-slate-700">“${ex.en}” ${audioButton}</p>
                            <p class="text-sm text-slate-500 italic ml-4">→ ${ex.vi}</p>
                        </li>`;
                    });
                    backHTML += `</ul></div>`;
                });
                backHTML += `</div>`;
                ui.cardBackContent.innerHTML = backHTML;
                
                attachAudioListeners(ui.cardBackContent);
                updateReviewButtonState();
            }, 150);

            updateNavigation();
        }

        function handleSrsAnswer(rating) {
            if (!isReviewMode || currentWords.length === 0) return;
            
            const wordKey = currentWords[currentIndex];
            updateSrsProgress(wordKey, rating);

            // Move to the next card in the review queue
            currentIndex++;
            if (currentIndex >= currentWords.length) {
                // End of review session
                ui.cardFrontContent.innerHTML = `<p class="text-xl text-slate-500">Chúc mừng! Bạn đã hoàn thành phiên ôn tập.</p>`;
                ui.cardBackContent.innerHTML = '';
                ui.srsControls.classList.add('hidden');
                createCategoryButtons(); // Refresh counts
            } else {
                displayCard();
            }
            updateNavigation();
        }
        
        // ... (rest of the functions like playAudio, etc. remain the same)
        // Note: I'll copy the necessary functions from the previous version.
        speechSynth.onvoiceschanged=()=>{if(!voicesLoaded){availableVoices=speechSynth.getVoices();voicesLoaded=true}};async function geminiFetch(e,t,o=3,i=1e3){if(!API_KEY)return console.warn("Gemini API Key is missing. Falling back to browser TTS."),null;const n=`https://generativelanguage.googleapis.com/v1beta/models/${e}:generateContent?key=${API_KEY}`;for(let e=0;e<o;e++){try{const o=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!o.ok){if(400===o.status)return showErrorModal("Lỗi API Key hoặc yêu cầu không hợp lệ. Vui lòng kiểm tra lại API Key của bạn."),null;throw new Error(`HTTP error! status: ${o.status}`)}return await o.json()}catch(t){if(console.error(`API call attempt ${e+1} failed:`,t),e===o-1)return showErrorModal(`Không thể kết nối tới Gemini API sau ${o} lần thử. ${t.message}`),null;await new Promise(e=>setTimeout(e,i*Math.pow(2,e)))}}}function base64ToArrayBuffer(e){const t=window.atob(e),o=t.length,i=new Uint8Array(o);for(let e=0;e<o;e++)i[e]=t.charCodeAt(e);return i.buffer}function pcmToWav(e,t){const o=1,i=2,n=2,s=t*n,a=e.byteLength,r=new ArrayBuffer(44+a),l=new DataView(r);!function(e,t,o){for(let i=0;i<o.length;i++)e.setUint8(t+i,o.charCodeAt(i))}(l,0,"RIFF"),l.setUint32(4,36+a,!0),l.setUint32(24,t,!0),l.setUint32(28,s,!0),l.setUint16(32,n,!0),l.setUint16(34,16,!0),l.setUint32(40,a,!0);const d=new Int16Array(e);for(let e=0;e<d.length;e++)l.setInt16(44+2*e,d[e],!0);return new Blob([l],{type:"audio/wav"})}function playBrowserAudio(e,t){const o=new SpeechSynthesisUtterance(e);o.lang="en-US";const i=t.innerHTML;t.innerHTML=loadingIconSVG,t.disabled=!0;const n=()=>{t.innerHTML=i,t.disabled=!1};o.onend=n,o.onerror=e=>{console.error("SpeechSynthesis Error:",e),n()};const s=()=>{const e=availableVoices.find(e=>"Google US English"===e.name)||availableVoices.find(e=>"en-US"===e.lang);e&&(o.voice=e),speechSynth.speak(o)};voicesLoaded?s():speechSynth.onvoiceschanged=()=>{voicesLoaded||(availableVoices=speechSynth.getVoices(),voicesLoaded=!0,t.disabled&&s())}}async function playAudio(e,t){if(e){if(speechSynth.speaking)return void speechSynth.cancel();if(currentApiAudio)return void currentApiAudio.pause();if(!API_KEY)return void playBrowserAudio(e,t);const o=t.innerHTML;t.innerHTML=loadingIconSVG,t.disabled=!0;try{const i={contents:[{parts:[{text:e}]}],generationConfig:{responseModalities:["AUDIO"],speechConfig:{voiceConfig:{prebuiltVoiceConfig:{voiceName:VOICE_NAME}}}},model:TTS_MODEL},n=await geminiFetch(TTS_MODEL,i);if(!n)return void playBrowserAudio(e,t);const s=n?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data,a=n?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType;if(!s||!a||!a.startsWith("audio/"))throw new Error("Invalid audio data received.");const r=parseInt(a.match(/rate=(\d+)/)[1],10),l=base64ToArrayBuffer(s),d=pcmToWav(l,r),c=URL.createObjectURL(d),u=new Audio(c),p=()=>{t.innerHTML=o,t.disabled=!1,URL.revokeObjectURL(c),currentApiAudio=null};currentApiAudio=u,u.onended=p,u.onpause=p,u.onerror=()=>{p(),showErrorModal("Lỗi khi phát file âm thanh.")},u.play()}catch(i){console.error("Error playing Gemini audio:",i),t.innerHTML=o,t.disabled=!1,playBrowserAudio(e,t)}}}async function playAudioSequence(e){for(const t of e){const o=t.dataset.textToSpeak;if(o){if(await new Promise(e=>{playAudio(o,t);const i=setInterval(()=>{t.disabled&&!isPlaying||(clearInterval(i),e())},100)}),!isPlaying)break}}}function findWordData(e){for(const t in vocabularyData){if("Chưa ghi nhớ"!==t&&vocabularyData[t][e])return vocabularyData[t][e]}return null}function updateReviewButtonState(){if(!currentWords||0===currentWords.length||"Chưa ghi nhớ"===currentCategoryKey)return void ui.reviewBtn.classList.remove("is-marked");const e=currentWords[currentIndex],t=!!vocabularyData["Chưa ghi nhớ"][e];ui.reviewBtn.classList.toggle("is-marked",t)}function handleReviewClick(){if(!currentWords||0===currentWords.length)return;const e=currentWords[currentIndex],t=!!vocabularyData["Chưa ghi nhớ"][e];t?delete vocabularyData["Chưa ghi nhớ"][e]:(wordData=findWordData(e))&&(vocabularyData["Chưa ghi nhớ"]||(vocabularyData["Chưa ghi nhớ"]={}),vocabularyData["Chưa ghi nhớ"][e]={...wordData}),saveDataToLocalStorage(),createCategoryButtons(),updateReviewButtonState()}function handleDeleteFromReview(){if("Chưa ghi nhớ"!==currentCategoryKey||0===currentWords.length)return;const e=currentWords[currentIndex];delete vocabularyData["Chưa ghi nhớ"][e],saveDataToLocalStorage(),currentWords.splice(currentIndex,1),currentIndex>=currentWords.length&&(currentIndex=Math.max(0,currentWords.length-1)),createCategoryButtons(),displayCard()}function updateNavigation(){const e=currentWords.length>0,t=currentWords.length>1,o=isPlaying||!e;ui.prevBtn.disabled=o||!t,ui.nextBtn.disabled=o||!t,ui.playPauseBtn.disabled=!e,ui.playSpeedInput.disabled=isPlaying,ui.autoFlipToggle.disabled=o,ui.autoPlayAudioToggle.disabled=o,ui.autoPlayExamplesToggle.disabled=o}function navigate(e){currentWords.length>0&&(currentIndex=(currentIndex+e+currentWords.length)%currentWords.length,displayCard())}function stopAutoplay(){isPlaying&&(isPlaying=!1,clearTimeout(flipTimeout),clearInterval(autoplayInterval),flipTimeout=null,autoplayInterval=null,speechSynth.speaking&&speechSynth.cancel(),currentApiAudio&&currentApiAudio.pause(),ui.playPauseBtn.innerHTML=playIconSVG,document.querySelectorAll(".category-button").forEach(e=>e.disabled=!1),ui.flashcard.style.pointerEvents="auto",updateNavigation())}function startAutoplay(){0!==currentWords.length?(isPlaying=!0,ui.playPauseBtn.innerHTML=pauseIconSVG,document.querySelectorAll(".category-button").forEach(e=>e.disabled=!0),ui.flashcard.style.pointerEvents="none",updateNavigation(),runAutoplayCycle()):showErrorModal("Vui lòng chọn một chủ đề có từ vựng để bắt đầu.")}async function runAutoplayCycle(){if(isPlaying){if(ui.flashcard.classList.contains("is-flipped")&&(ui.flashcard.classList.remove("is-flipped"),await new Promise(e=>setTimeout(e,350))),displayCard(),await new Promise(e=>setTimeout(e,200)),!isPlaying)return;const e=ui.autoFlipToggle.checked,t=ui.autoPlayAudioToggle.checked,o=ui.autoPlayExamplesToggle.checked;let i=1e3*parseInt(ui.playSpeedInput.value,10);if(await new Promise(t=>setTimeout(t,e?i/2:i)),!isPlaying)return;if(e&&(ui.flashcard.classList.add("is-flipped"),await new Promise(e=>setTimeout(e,200)),isPlaying&&(t||o))){const e=currentWords[currentIndex],i=[];if(t){const t=ui.cardBackContent.querySelector(`.play-audio-btn[data-text-to-speak="${e}"]`);t&&i.push(t)}if(o){const t=ui.cardBackContent.querySelectorAll(`.play-audio-btn:not([data-text-to-speak="${e}"])`);t.length>0&&i.push(t[0])}await playAudioSequence(i)}if(isPlaying&&await new Promise(e=>setTimeout(e,i/2)),!isPlaying)return;navigate(1),runAutoplayCycle()}}function showErrorModal(e){ui.errorMessage.textContent=e,ui.errorModal.classList.remove("hidden")}

        function initializeApp(data) {
            vocabularyData = data;
            if (!vocabularyData["Chưa ghi nhớ"]) {
                vocabularyData["Chưa ghi nhớ"] = {};
            }
            loadDataFromLocalStorage(); 
            loadSrsProgress();
            ui.playPauseBtn.innerHTML = playIconSVG;
            createCategoryButtons();
            updateNavigation();
            ui.reviewBtn.style.display = 'none';
            ui.deleteBtn.style.display = 'none';
            
            ui.prevBtn.addEventListener('click', () => navigate(-1));
            ui.nextBtn.addEventListener('click', () => navigate(1));
            ui.flashcard.addEventListener('click', (e) => {
                if (e.target.closest('.card-action-btn') || e.target.closest('.play-audio-btn')) return;
                if (currentWords.length > 0) {
                    ui.flashcard.classList.toggle('is-flipped');
                    if (isReviewMode && ui.flashcard.classList.contains('is-flipped')) {
                        ui.srsControls.classList.remove('hidden');
                        ui.srsControls.classList.add('flex');
                    } else {
                        ui.srsControls.classList.add('hidden');
                    }
                }
            });
            let touchstartX = 0;
            ui.flashcard.addEventListener('touchstart', e => { touchstartX = e.changedTouches[0].screenX; }, { passive: true });
            ui.flashcard.addEventListener('touchend', e => { 
                let touchendX = e.changedTouches[0].screenX;
                const swipeThreshold = 50;
                if (touchendX < touchstartX - swipeThreshold) { if (!ui.nextBtn.disabled) navigate(1); }
                if (touchendX > touchstartX + swipeThreshold) { if (!ui.prevBtn.disabled) navigate(-1); }
            });

            ui.playPauseBtn.addEventListener('click', () => { isPlaying ? stopAutoplay() : startAutoplay(); });
            ui.reviewBtn.addEventListener('click', handleReviewClick);
            ui.deleteBtn.addEventListener('click', handleDeleteFromReview);
            ui.closeErrorModalBtn.addEventListener('click', () => ui.errorModal.classList.add('hidden'));
            
            document.querySelectorAll('.srs-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    handleSrsAnswer(e.target.dataset.rating);
                });
            });

            const firstCategory = Object.keys(vocabularyData).find(k => k !== "Chưa ghi nhớ");
            if(firstCategory) {
                selectCategory(firstCategory);
            } else {
                 ui.cardFrontContent.innerHTML = `<p class="text-xl text-slate-500">Không có dữ liệu từ vựng nào.</p>`;
            }
        }

        async function startApp() {
            try {
                const response = await fetch('vocabulary.json');
                if (!response.ok) {
                    throw new Error(`Không tìm thấy tệp vocabulary.json hoặc có lỗi mạng (status: ${response.status})`);
                }
                const data = await response.json();
                initializeApp(data);
            } catch (error) {
                console.error('Could not load vocabulary data:', error);
                ui.cardFrontContent.innerHTML = `<p class="text-xl text-red-500 text-center"><b>Lỗi nghiêm trọng:</b><br>${error.message}<br><br>Hãy chắc chắn rằng bạn đã tải lên tệp <b>vocabulary.json</b> vào cùng một kho chứa trên GitHub.</p>`;
            }
        }

        startApp();
    </script>
</body>
</html>
